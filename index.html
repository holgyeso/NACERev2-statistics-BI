<!DOCTYPE html>
<html>
  <head>
    <title>Embedding Vega-Lite</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.2"></script>
  </head>
  <body>
    <select id="year">
      <option>2019</option>
      <option>2018</option>
      <option>2017</option>
      <option>2016</option>
      <option>2015</option>
    </select>
    <select id="indicator">
        <option>V11110</option>
        <option>V12150</option>
    </select>
    <select id="nace">
        <option>B</option>
        <option>C</option>
        <option>D</option>
    </select>
    <div id="vis"></div>

    <script type="text/javascript">

        let requestURL = 'https://raw.githubusercontent.com/holgyeso/holgyeso.github.io/main/vega_exportt.json';
        let request = new XMLHttpRequest();
        request.open('GET', requestURL);
        request.responseType = 'json';
        request.send();

        let df = [];

        request.onload = function() { 

            df = request.response;

            let array_to_show = df;

            vega_prepare_data();

            document.getElementById("year").addEventListener("change", vega_prepare_data);
            document.getElementById("indicator").addEventListener("change", vega_prepare_data);
            document.getElementById("nace").addEventListener("change", vega_prepare_data);

        }

        function vega_prepare_data() {
            let year = document.getElementById("year").value;
            let indicator = document.getElementById("indicator").value;
            let nace = document.getElementById("nace").value;
            console.log(year, indicator, nace);
            
            let array_to_show = [];
            for (let val of df.values()) {
                if (val['year'] == year && val['nace_r2'] == nace && val['indicator'] == indicator)
                    array_to_show.push(val);
            }
            console.log(array_to_show);

            vega_viz(array_to_show);
        }

        function vega_viz(data_array) {

      var yourVlSpec = {
        "$schema": 'https://vega.github.io/schema/vega-lite/v5.json',
        "description": 'A simple bar chart with embedded data.',
        "data": {
          "values": data_array
        },
        "mark": 'bar',
        "encoding": {
            "x": {"field": "country_code", "type": "nominal", "axis": {"labelAngle": 0}},
            "y": {"field": "value", "type": "quantitative"}
        }
      };
      
      vegaEmbed('#vis', yourVlSpec);

      };
    

      
    </script>
  </body>
